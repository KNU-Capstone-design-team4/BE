import os
import json
import uuid
import datetime
import numpy as np
import asyncio
from pathlib import Path
from typing import Dict, Optional, Any, Tuple, List
from openai import AsyncOpenAI
from docxtpl import DocxTemplate
from sqlalchemy.ext.asyncio import AsyncSession

from app import schemas

client = AsyncOpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

# --- 1. í†µí•©ì‹ ì²­ì„œ ì „ìš© ì‹œë‚˜ë¦¬ì˜¤ ---
# (ë¯¸ë¦¬ ì‘ì„±í•´ë‘ì‹  'í†µí•©ì‹ ì²­ì„œ' ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.)
# â—ï¸ field_idëŠ” 1ë‹¨ê³„ì—ì„œ ë§Œë“  .docx í…œí”Œë¦¿ì˜ {{ ë³€ìˆ˜ëª… }}ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
CONTRACT_SCENARIO = [
    {"field_id": "surname", "question": "ì—¬ê¶Œìƒì˜ ì„±(Surname)ì„ ì˜ë¬¸ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "given_names", "question": "ì—¬ê¶Œìƒì˜ ì´ë¦„(Given names)ì„ ì˜ë¬¸ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "birth", "question": "ìƒë…„ì›”ì¼ì„ ì•Œë ¤ì£¼ì„¸ìš”.(yyy-mm-dd í˜•ì‹)"},
    {"field_id": "sex", "question": "ì„±ë³„ì„ ì•Œë ¤ì£¼ì„¸ìš”. (ë‚¨ / ì—¬)"},
    {"field_id": "nation", "question": "êµ­ì ì„ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "passport_num", "question": "ì—¬ê¶Œë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "passport_date", "question": "ì—¬ê¶Œ ë°œê¸‰ì¼ìë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "passport_expired", "question": "ì—¬ê¶Œ ìœ íš¨ê¸°ê°„ì„ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "korea_address", "question": "ëŒ€í•œë¯¼êµ­ ë‚´ ì£¼ì†Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "tele_num", "question": "ì „í™” ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "phone_num", "question": "íœ´ëŒ€ ì „í™” ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”"},
    {"field_id": "address_in_home_country", "question": "ë³¸êµ­ ì£¼ì†Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "email", "question": "ì´ë©”ì¼ì„ ì•Œë ¤ì£¼ì„¸ìš”"},
    
    # --- 2. ì‹ ì²­ í•­ëª© (ì²« ë²ˆì§¸ ë¶„ê¸°ì ) ---
    {"field_id": "application_type", "question": "ì‹ ì²­/ì‹ ê³  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n1. ì™¸êµ­ì¸ ë“±ë¡, 2. ë“±ë¡ì¦ ì¬ë°œê¸‰, 3. ì²´ë¥˜ê¸°ê°„ ì—°ì¥í—ˆê°€, 4. ì²´ë¥˜ìê²© ë³€ê²½í—ˆê°€, 5. ì²´ë¥˜ìê²© ë¶€ì—¬,\n6. ì²´ë¥˜ìê²©ì™¸ í™œë™í—ˆê°€, 7. ê·¼ë¬´ì²˜ ë³€ê²½/ì¶”ê°€í—ˆê°€, 8. ì²´ë¥˜ì§€ ë³€ê²½ì‹ ê³ , 9. ë“±ë¡ì‚¬í•­ ë³€ê²½ì‹ ê³ )"},
    
    # 2-1. [ì¡°ê±´ë¶€ ì§ˆë¬¸ 1] 'ì²´ë¥˜ìê²© ë³€ê²½í—ˆê°€' ì„ íƒ ì‹œ
    {"field_id": "app_change_desired", "question": "ë³€ê²½ì„ í¬ë§í•˜ëŠ” ì²´ë¥˜ ìê²©ì€ ë¬´ì—‡ì¸ê°€ìš”? (ì˜ˆ: E-7)"},
    # 2-2. [ì¡°ê±´ë¶€ ì§ˆë¬¸ 2] 'ì²´ë¥˜ìê²© ë¶€ì—¬' ì„ íƒ ì‹œ
    {"field_id": "app_grant_desired", "question": "ë¶€ì—¬ë°›ê³ ì í•˜ëŠ” ì²´ë¥˜ ìê²©ì€ ë¬´ì—‡ì¸ê°€ìš”?"},
    # 2-3. [ì¡°ê±´ë¶€ ì§ˆë¬¸ 3] 'ì²´ë¥˜ìê²©ì™¸ í™œë™í—ˆê°€' ì„ íƒ ì‹œ
    {"field_id": "app_other_desired", "question": "í—ˆê°€ë°›ê³ ì í•˜ëŠ” í™œë™ì˜ ë‚´ìš©ì€ ë¬´ì—‡ì¸ê°€ìš”?"},
    
    # --- 3. ì§ì—… (ë‘ ë²ˆì§¸ ë¶„ê¸°ì ) ---
    {"field_id": "occupation_type", "question": "í˜„ì¬ ì§ì—…ì´ 'í•™ìƒ'ì¸ê°€ìš”, 'ê·¼ë¬´ì'ì¸ê°€ìš”, ì•„ë‹ˆë©´ 'ê¸°íƒ€/ë¯¸ì·¨í•™'ì¸ê°€ìš”?"},

    # 3-1. [ì¡°ê±´ë¶€ ì§ˆë¬¸ 4] 'í•™ìƒ' ì„ íƒ ì‹œ
    {"field_id": "school_status", "question": "ì¬í•™ì—¬ë¶€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.(ë¯¸ì·¨í•™, ì´ˆ, ì¤‘, ê³ )"},
    {"field_id": "school_type", "question": "í•™êµ ì¢…ë¥˜ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”(êµìœ¡ì²­ ì¸ê°€, êµìœ¡ì²­ ë¹„ì¸ê°€, ëŒ€ì•ˆí•™êµ)"},
    {"field_id": "school_name", "question": "í•™êµì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”"},

    # 3-2. [ì¡°ê±´ë¶€ ì§ˆë¬¸ 5] 'ê·¼ë¬´ì' ì„ íƒ ì‹œ
    {"field_id": "current_workplace", "question": "í˜„ì¬ ê·¼ë¬´ì²˜(íšŒì‚¬ëª…)ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "business_regis_num_current", "question": "í˜„ì¬ ê·¼ë¬´ì²˜ì˜ ì‚¬ì—…ìë“±ë¡ ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "occupation", "question": "í˜„ì¬ ì§ì—…(ì§ì¢…)ì„ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "annual_income", "question": "ì—° ì†Œë“ ê¸ˆì•¡ì„ ë§Œì› ë‹¨ìœ„ë¡œ ì•Œë ¤ì£¼ì„¸ìš”."},
    
    # 3-3. [ì¡°ê±´ë¶€ ì§ˆë¬¸ 6] 'ê·¼ë¬´ì²˜ ë³€ê²½' ì‹ ì²­ ì‹œ
    {"field_id": "new_workplace", "question": "ìƒˆë¡œ ê·¼ë¬´í•  ì˜ˆì •ì¸ ì¥ì†Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},
    {"field_id": "business_regis_num_new", "question": "ìƒˆ ê·¼ë¬´ì²˜ì˜ ì‚¬ì—…ìë“±ë¡ ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."},

    # --- 4. ê³µí†µ ë§ˆë¬´ë¦¬ ---
    {"field_id": "refund_bank_account", "question": "ë°˜í™˜ìš© ê³„ì¢Œë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš” (í•„ìš”ì‹œ)"},
]

TIP_LIST = [
    "1. (ì™¸êµ­ì¸ì˜ ì…êµ­-ì œ7ì¡°) ì™¸êµ­ì¸ì´ ì…êµ­í•  ë•Œì—ëŠ” ìœ íš¨í•œ ì—¬ê¶Œê³¼ ë²•ë¬´ë¶€ì¥ê´€ì´ ë°œê¸‰í•œ ì‚¬ì¦(æŸ»è­‰)ì„ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤.",
    "2. (ì™¸êµ­ì¸ì˜ ì…êµ­-ì œ7ì¡°)ì¬ì…êµ­ í—ˆê°€ë¥¼ ë°›ì•˜ê±°ë‚˜ ë©´ì œëœ ê¸°ê°„ì´ ëë‚˜ê¸° ì „ì— ì…êµ­í•˜ëŠ” ì™¸êµ­ì¸, ì‚¬ì¦ë©´ì œí˜‘ì •ì„ ì²´ê²°í•œ êµ­ê°€ì˜ êµ­ë¯¼, ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ë”°ë¡œ ì…êµ­í—ˆê°€ë¥¼ ë°›ì€ êµ­ì œì¹œì„ Â·ê´€ê´‘ ëª©ì ì˜ ì™¸êµ­ì¸, ë˜ëŠ” ë‚œë¯¼ì—¬í–‰ì¦ëª…ì„œ ìœ íš¨ê¸°ê°„ ë‚´ì— ì…êµ­í•˜ëŠ” ì™¸êµ­ì¸ì€ ì‚¬ì¦(ë¹„ì) ì—†ì´ ì…êµ­í•  ìˆ˜ ìˆë‹¤.",
    "3. (ì™¸êµ­ì¸ì˜ ì…êµ­-ì œ7ì¡°)ë²•ë¬´ë¶€ì¥ê´€ì€ ê³µê³µì§ˆì„œì˜ ìœ ì§€ë‚˜ êµ­ê°€ì´ìµì— í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•˜ë©´ ì œ2í•­ì œ2í˜¸ì— í•´ë‹¹í•˜ëŠ” ì‚¬ëŒì— ëŒ€í•˜ì—¬ ì‚¬ì¦ë©´ì œí˜‘ì •ì˜ ì ìš©ì„ ì¼ì‹œ ì •ì§€í•  ìˆ˜ ìˆë‹¤.",
    "4. (ì™¸êµ­ì¸ì˜ ì…êµ­-ì œ7ì¡°)ëŒ€í•œë¯¼êµ­ê³¼ ìˆ˜êµ(ä¿®äº¤)í•˜ì§€ ì•„ë‹ˆí•œ êµ­ê°€ë‚˜ ë²•ë¬´ë¶€ì¥ê´€ì´ ì™¸êµë¶€ì¥ê´€ê³¼ í˜‘ì˜í•˜ì—¬ ì§€ì •í•œ êµ­ê°€ì˜ êµ­ë¯¼ì€ ì œ1í•­ì—ë„ ë¶ˆêµ¬í•˜ê³  ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì¬ì™¸ê³µê´€ì˜ ì¥ì´ë‚˜ ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì´ ë°œê¸‰í•œ ì™¸êµ­ì¸ì…êµ­í—ˆê°€ì„œë¥¼ ê°€ì§€ê³  ì…êµ­í•  ìˆ˜ ìˆë‹¤.",
    "5. (ì²´ë¥˜ìê²©-ì œ10ì¡°)ì…êµ­ ì™¸êµ­ì¸ì€ ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜ ê¸°ê°„ì´ ì œí•œë˜ëŠ” ì¼ë°˜ì²´ë¥˜ìê²©ì´ë‚˜ ì˜ì£¼(æ°¸ä½)í•  ìˆ˜ ìˆëŠ” ì˜ì£¼ìê²© ì¤‘ ì–´ëŠ í•˜ë‚˜ë¥¼ ê°€ì ¸ì•¼ í•œë‹¤.",
    "6. (ì²´ë¥˜ìê²©-ì œ10ì¡°)ì¼ë°˜ì²´ë¥˜ìê²©ì€ ê´€ê´‘, ë°©ë¬¸ ë“±ì˜ ëª©ì ìœ¼ë¡œ 90ì¼ ì´í•˜ì˜ ê¸°ê°„ ë™ì•ˆ ë¨¸ë¬¼ ìˆ˜ ìˆëŠ” ë‹¨ê¸°ì²´ë¥˜ìê²©ê³¼ ìœ í•™, ì—°ìˆ˜, íˆ¬ì, ì£¼ì¬, ê²°í˜¼ ë“±ì˜ ëª©ì ìœ¼ë¡œ 90ì¼ì„ ì´ˆê³¼í•˜ì—¬ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ê¸°ê°„ ë™ì•ˆ ê±°ì£¼í•  ìˆ˜ ìˆëŠ” ì¥ê¸°ì²´ë¥˜ìê²©ìœ¼ë¡œ êµ¬ë¶„ë˜ë©°, ì´ ë‘ ì²´ë¥˜ìê²©ì˜ ì¢…ë¥˜, í•´ë‹¹ ëŒ€ìƒ ë˜ëŠ” í™œë™ ë²”ìœ„ëŠ” ì²´ë¥˜ëª©ì ì´ë‚˜ ì·¨ì—…í™œë™ ê°€ëŠ¥ ì—¬ë¶€ ë“±ì„ ê³ ë ¤í•˜ì—¬ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "7. (ì²´ë¥˜ìê²©-ì œ10ì¡°)ì˜ì£¼ìê²©ì„ ê°€ì§„ ì™¸êµ­ì¸ì€ í™œë™ë²”ìœ„ ë° ì²´ë¥˜ê¸°ê°„ì˜ ì œí•œì„ ë°›ì§€ ì•Šìœ¼ë©°, ì´ ì˜ì£¼ìê²©ì„ ì·¨ë“í•˜ë ¤ëŠ” ì‚¬ëŒì€ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ìê²©ì— ë¶€í•©í•´ì•¼ í•˜ê³ , ë²•ë ¹ ì¤€ìˆ˜ ë“±ì˜ í’ˆí–‰ ë‹¨ì •, ìƒê³„ ìœ ì§€ ëŠ¥ë ¥, í•œêµ­ì–´ ëŠ¥ë ¥ ë° í•œêµ­ ì‚¬íšŒì— ëŒ€í•œ ì´í•´ ë“±ì˜ ê¸°ë³¸ ì†Œì–‘ ìš”ê±´ì„ ëª¨ë‘ ê°–ì¶”ì–´ì•¼ í•˜ì§€ë§Œ, ë²•ë¬´ë¶€ì¥ê´€ì€ íŠ¹ë³„ ê³µë¡œìë‚˜ íŠ¹ì • ë¶„ì•¼ íƒì›” ëŠ¥ë ¥ì, ì¼ì • ê¸ˆì•¡ ì´ìƒ íˆ¬ìì ë“± ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ì‚¬ëŒì— ëŒ€í•´ì„œëŠ” ìƒê³„ ìœ ì§€ ëŠ¥ë ¥ ë° ê¸°ë³¸ ì†Œì–‘ ìš”ê±´ì˜ ì „ë¶€ ë˜ëŠ” ì¼ë¶€ë¥¼ ì™„í™”í•˜ê±°ë‚˜ ë©´ì œí•  ìˆ˜ ìˆê³ , ì´ ìš”ê±´ë“¤ì˜ ê¸°ì¤€ê³¼ ë²”ìœ„ ë“± ì„¸ë¶€ ì‚¬í•­ì€ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "8. (ì‚¬ì „ì—¬í–‰í—ˆê°€-ì œ7ì¡°ì˜ 3)ë²•ë¬´ë¶€ì¥ê´€ì€ ê³µê³µì§ˆì„œ ìœ ì§€ë‚˜ êµ­ê°€ì´ìµì„ ìœ„í•´ í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•˜ëŠ” ê²½ìš°, ì‚¬ì¦ë©´ì œí˜‘ì •êµ­ êµ­ë¯¼ì´ë‚˜ ë¬´ì‚¬ì¦ì…êµ­ì´ í—ˆê°€ëœ ì™¸êµ­ì¸ ë“± íŠ¹ì • ì™¸êµ­ì¸ì— ëŒ€í•´ ì…êµ­ ì „ ì‚¬ì „ì—¬í–‰í—ˆê°€ë¥¼ ë°›ë„ë¡ í•  ìˆ˜ ìˆìœ¼ë©°, í—ˆê°€ë¥¼ ë°›ì€ ì™¸êµ­ì¸ì€ ì…êµ­ ì‹œ ì‚¬ì „ì—¬í–‰í—ˆê°€ì„œë¥¼ ì§€ì°¸í•´ì•¼ í•˜ê³ , ì´ í—ˆê°€ì„œ ë°œê¸‰ì— í•„ìš”í•œ ê¸°ì¤€, ì ˆì°¨ ë° ë°©ë²•ì€ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "9. (í—ˆìœ„ì´ˆì²­ê¸ˆì§€-ì œ7ì¡°ì˜2)ëˆ„êµ¬ë“ ì§€ ì™¸êµ­ì¸ì„ ì…êµ­ì‹œí‚¤ê¸° ìœ„í•´ ê±°ì§“ëœ ì‚¬ì‹¤ ê¸°ì¬ë‚˜ ê±°ì§“ëœ ì‹ ì›ë³´ì¦ ë“± ë¶€ì •í•œ ë°©ë²•ìœ¼ë¡œ ì™¸êµ­ì¸ì„ ì´ˆì²­í•˜ê±°ë‚˜ ê·¸ ì´ˆì²­ì„ ì•Œì„ í•˜ëŠ” í–‰ìœ„, ë˜ëŠ” ê±°ì§“ìœ¼ë¡œ ì‚¬ì¦ì´ë‚˜ ì‚¬ì¦ë°œê¸‰ì¸ì •ì„œë¥¼ ì‹ ì²­í•˜ê±°ë‚˜ ê·¸ëŸ¬í•œ ì‹ ì²­ì„ ì•Œì„ í•˜ëŠ” í–‰ìœ„ë¥¼ í•´ì„œëŠ” ì•ˆ ëœë‹¤.",
    "10. (ì‚¬ì¦-8ì¡°)ì œ7ì¡°ì— ë”°ë¥¸ ì‚¬ì¦ì€ 1íšŒë§Œ ì…êµ­ ê°€ëŠ¥í•œ ë‹¨ìˆ˜ì‚¬ì¦(å–®æ•¸æŸ»è­‰)ê³¼ 2íšŒ ì´ìƒ ì…êµ­ ê°€ëŠ¥í•œ ë³µìˆ˜ì‚¬ì¦(è¤‡æ•¸æŸ»è­‰)ìœ¼ë¡œ êµ¬ë¶„ë˜ë©°, ë²•ë¬´ë¶€ì¥ê´€ì€ ì‚¬ì¦ ë°œê¸‰ ê¶Œí•œì„ ëŒ€í†µë ¹ë ¹ì— ë”°ë¼ ì¬ì™¸ê³µê´€ì˜ ì¥ì—ê²Œ ìœ„ì„í•  ìˆ˜ ìˆê³ , ê·¸ ë°œê¸‰ ê¸°ì¤€ ë° ì ˆì°¨ëŠ” ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "11. (ì‚¬ì¦ë°œê¸‰ì¸ì¦ì„œ-9ì¡°)ë²•ë¬´ë¶€ì¥ê´€ì€ ì‚¬ì¦ì„ ë°œê¸‰í•˜ê¸° ì „ì— íŠ¹íˆ í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•  ê²½ìš° ì…êµ­í•˜ë ¤ëŠ” ì™¸êµ­ì¸ì˜ ì‹ ì²­ì„ ë°›ì•„ ì‚¬ì¦ë°œê¸‰ì¸ì •ì„œë¥¼ ë°œê¸‰í•  ìˆ˜ ìˆìœ¼ë©°, ì´ ì‹ ì²­ì€ ì™¸êµ­ì¸ì„ ì´ˆì²­í•˜ë ¤ëŠ” ìê°€ ëŒ€ë¦¬í•  ìˆ˜ ìˆê³ , ì¸ì •ì„œì˜ ë°œê¸‰ ëŒ€ìƒ, ê¸°ì¤€ ë° ì ˆì°¨ëŠ” ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "12. (ì˜ì£¼ìê²©ìì˜ í™œë™ë²”ìœ„-ì œ10ì¡°ì˜3í˜¸)ì œ10ì¡°ì œ2í˜¸ì— ë”°ë¥¸ ì˜ì£¼ìê²©(ì´í•˜ â€œì˜ì£¼ìê²©â€ì´ë¼ í•œë‹¤)ì„ ê°€ì§„ ì™¸êµ­ì¸ì€ í™œë™ë²”ìœ„ ë° ì²´ë¥˜ê¸°ê°„ì˜ ì œí•œì„ ë°›ì§€ ì•„ë‹ˆí•œë‹¤.",
    "13. (ì…êµ­ê¸ˆì§€-ì œ11ì¡°)ë²•ë¬´ë¶€ì¥ê´€ì€ ê°ì—¼ë³‘ í™˜ì, ë§ˆì•½ë¥˜ ì¤‘ë…ì, ì´í¬ã†ë„ê²€ ë“±ì„ ìœ„ë²•í•˜ê²Œ ì†Œì§€í•œ ì‚¬ëŒ, ëŒ€í•œë¯¼êµ­ì˜ ì´ìµì´ë‚˜ ê³µê³µì˜ ì•ˆì „ ë° ì„ ëŸ‰í•œ í’ì†ì„ í•´ì¹  ì—¼ë ¤ê°€ ìˆëŠ” ì‚¬ëŒ, êµ¬í˜¸(æ•‘è­·)ê°€ í•„ìš”í•œ ì •ì‹ ì¥ì• ì¸ì´ë‚˜ ì²´ë¥˜ ë¹„ìš© ë¶€ë‹´ ëŠ¥ë ¥ì´ ì—†ëŠ” ì‚¬ëŒ, ê°•ì œí‡´ê±° í›„ 5ë…„ì´ ì§€ë‚˜ì§€ ì•Šì€ ì‚¬ëŒ, ê³¼ê±° ì¸ê¶Œ í•™ì‚´ì— ê´€ì—¬í•œ ì‚¬ëŒ, ê·¸ë¦¬ê³  ê·¸ ë°–ì— ë²•ë¬´ë¶€ì¥ê´€ì´ ì…êµ­ ë¶€ì ë‹¹í•˜ë‹¤ê³  ì¸ì •í•˜ëŠ” ì‚¬ëŒì— ëŒ€í•˜ì—¬ ì…êµ­ì„ ê¸ˆì§€í•  ìˆ˜ ìˆìœ¼ë©°, ì…êµ­í•˜ë ¤ëŠ” ì™¸êµ­ì¸ì˜ ë³¸êµ­ì´ ìƒí˜¸ì£¼ì˜ ì›ì¹™ì— ë”°ë¼ ìêµ­ë¯¼ ì…êµ­ì„ ê±°ë¶€í•˜ëŠ” ê²½ìš°ì—ë„ ë™ì¼í•œ ì‚¬ìœ ë¡œ ê·¸ ì™¸êµ­ì¸ì˜ ì…êµ­ì„ ê±°ë¶€í•  ìˆ˜ ìˆë‹¤.",
    "14. (ì…êµ­ì‹¬ì‚¬ ì˜ë¬´-ì œ12ì¡° 1í•­)ì™¸êµ­ì¸ì´ ì…êµ­í•˜ë ¤ëŠ” ê²½ìš°ì—ëŠ” ì…êµ­í•˜ëŠ” ì¶œì…êµ­í•­ì—ì„œ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì—¬ê¶Œê³¼ ì…êµ­ì‹ ê³ ì„œë¥¼ ì¶œì…êµ­ê´€ë¦¬ê³µë¬´ì›ì—ê²Œ ì œì¶œí•˜ì—¬ ì…êµ­ì‹¬ì‚¬ë¥¼ ë°›ì•„ì•¼ í•œë‹¤.",
    "15. (ì…êµ­ í—ˆê°€ ìš”ê±´-ì œ12ì¡° 3í•­)ì¶œì…êµ­ê´€ë¦¬ê³µë¬´ì›ì€ ì…êµ­ì‹¬ì‚¬ ì‹œ ì—¬ê¶Œ ë° ì´ ë²•ì—ì„œ ìš”êµ¬í•˜ëŠ” ì‚¬ì¦ì´ ìœ íš¨í•˜ê³ , ì‚¬ì „ì—¬í–‰í—ˆê°€ì„œ(ì œ7ì¡°ì˜3ì œ2í•­ì— ë”°ë¦„)ê°€ ìœ íš¨í•˜ë©°, ì…êµ­ ëª©ì ì´ ì²´ë¥˜ìê²©ì— ë§ê³ , ì²´ë¥˜ ê¸°ê°„ì´ ë²•ë¬´ë¶€ë ¹ì— ë”°ë¼ ì •í•´ì¡Œì„ ë¿ë§Œ ì•„ë‹ˆë¼, ì œ11ì¡°ì— ë”°ë¥¸ ì…êµ­ ê¸ˆì§€ ë˜ëŠ” ê±°ë¶€ ëŒ€ìƒì´ ì•„ë‹ ê²½ìš°ì— í•œí•˜ì—¬ ì…êµ­ì„ í—ˆê°€í•œë‹¤.",
    "16. (ì…êµ­ ì‹œ ìƒì²´ì •ë³´ ì œê³µ ì˜ë¬´- ì œ12ì¡°2 ì œ1í•­)ì…êµ­í•˜ë ¤ëŠ” ì™¸êµ­ì¸ì€ ì œ12ì¡°ì— ë”°ë¥¸ ì…êµ­ì‹¬ì‚¬ë¥¼ ë°›ì„ ë•Œ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ìƒì²´ì •ë³´ë¥¼ ì œê³µí•˜ê³  ë³¸ì¸ í™•ì¸ ì ˆì°¨ì— ì‘í•´ì•¼ í•˜ë‚˜, 17ì„¸ ë¯¸ë§Œì¸ ì‚¬ëŒ, ì™¸êµ­ ì •ë¶€ë‚˜ êµ­ì œê¸°êµ¬ ì—…ë¬´ ìˆ˜í–‰ì„ ìœ„í•´ ì…êµ­í•˜ëŠ” ì‚¬ëŒ ë° ê·¸ ë™ë°˜ ê°€ì¡±, ê·¸ë¦¬ê³  ìš°í˜¸ ì¦ì§„ ë° ê²½ì œí™œë™ ì´‰ì§„ ë“±ì„ ê³ ë ¤í•˜ì—¬ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ìƒì²´ì •ë³´ ì œê³µì„ ë©´ì œí•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤ê³  ì •í•˜ëŠ” ì‚¬ëŒì— ëŒ€í•´ì„œëŠ” ì˜ˆì™¸ë¡œ í•œë‹¤.",
    "17. (ì…êµ­ ì‹œ ìƒì²´ì •ë³´ ì œê³µ ì˜ë¬´- ì œ12ì¡°2)ì¶œì…êµ­ê´€ë¦¬ê³µë¬´ì›ì€ ì™¸êµ­ì¸ì´ ì œ1í•­ ë³¸ë¬¸ì— ë”°ë¼ ìƒì²´ì •ë³´ë¥¼ ì œê³µí•˜ì§€ ì•„ë‹ˆí•˜ëŠ” ê²½ìš°ì—ëŠ” ê·¸ì˜ ì…êµ­ì„ í—ˆê°€í•˜ì§€ ì•„ë‹ˆí•  ìˆ˜ ìˆë‹¤.",
    "18. (ì…êµ­ ì‹œ ìƒì²´ì •ë³´ ì œê³µ ì˜ë¬´- ì œ12ì¡°2) ë²•ë¬´ë¶€ì¥ê´€ì€ ì…êµ­ì‹¬ì‚¬ì— í•„ìš”í•œ ê²½ìš°ì—ëŠ” ê´€ê³„ í–‰ì •ê¸°ê´€ì´ ë³´ìœ í•˜ê³  ìˆëŠ” ì™¸êµ­ì¸ì˜ ìƒì²´ì •ë³´ì˜ ì œì¶œì„ ìš”ì²­í•  ìˆ˜ ìˆë‹¤.",
    "19. (ì„ ë°•ë“±ì˜ ì œê³µê¸ˆì§€-ì œ12ì¡°ì˜3)ëˆ„êµ¬ë“ ì§€ ì™¸êµ­ì¸ì„ ë¶ˆë²•ìœ¼ë¡œ ì…êµ­ ë˜ëŠ” ì¶œêµ­ì‹œí‚¤ê±°ë‚˜ ëŒ€í•œë¯¼êµ­ì„ ê±°ì³ ë‹¤ë¥¸ êµ­ê°€ì— ë¶ˆë²•ìœ¼ë¡œ ì…êµ­ì‹œí‚¤ë ¤ëŠ” ëª©ì ìœ¼ë¡œ ì„ ë°• ë“±ì´ë‚˜ ì—¬ê¶Œ, ì‚¬ì¦, íƒ‘ìŠ¹ê¶Œ ë° ê·¸ ë°–ì— ì¶œì…êµ­ì— ì‚¬ìš©ë  ìˆ˜ ìˆëŠ” ì„œë¥˜ë‚˜ ë¬¼í’ˆì„ ì œê³µí•˜ê±°ë‚˜, ì´ëŸ¬í•œ í–‰ìœ„ë¥¼ ì•Œì„ í•´ì„œëŠ” ì•ˆ ëœë‹¤.",
    "20. (ì„ ë°•ë“±ì˜ ì œê³µê¸ˆì§€-ì œ12ì¡°ì˜3)ëˆ„êµ¬ë“ ì§€ ë¶ˆë²•ìœ¼ë¡œ ì…êµ­í•œ ì™¸êµ­ì¸ì„ ëŒ€í•œë¯¼êµ­ì—ì„œ ì€ë‹‰í•˜ê±°ë‚˜ ë„í”¼í•˜ê²Œ í•˜ê±°ë‚˜ ê·¸ëŸ¬í•œ ëª©ì ìœ¼ë¡œ êµí†µìˆ˜ë‹¨ì„ ì œê³µí•˜ëŠ” í–‰ìœ„, ë˜ëŠ” ì´ëŸ¬í•œ í–‰ìœ„ë¥¼ ì•Œì„ í•´ì„œëŠ” ì•ˆ ëœë‹¤.",
    "21. (ì¡°ê±´ë¶€ ì…êµ­í—ˆê°€ â€“ì œ13ì¡°)ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì€ ë¶€ë“ì´í•œ ì‚¬ìœ ë¡œ ì œ12ì¡°ì œ3í•­ì œ1í˜¸ì˜ ìš”ê±´ì„ ê°–ì¶”ì§€ ëª»í•˜ì˜€ìœ¼ë‚˜ ì¼ì • ê¸°ê°„ ë‚´ì— ê°–ì¶œ ìˆ˜ ìˆë‹¤ê³  ì¸ì •ë˜ëŠ” ì‚¬ëŒ, ì œ11ì¡°ì œ1í•­ ê° í˜¸ì— í•´ë‹¹ëœë‹¤ê³  ì˜ì‹¬ë˜ê±°ë‚˜ ì œ12ì¡°ì œ3í•­ì œ2í˜¸ì˜ ìš”ê±´ì„ ê°–ì¶”ì§€ ëª»í•˜ì˜€ë‹¤ê³  ì˜ì‹¬ë˜ì–´ íŠ¹ë³„íˆ ì‹¬ì‚¬í•  í•„ìš”ê°€ ìˆëŠ” ì‚¬ëŒ, ë˜ëŠ” ê·¸ ë°–ì— ì¡°ê±´ë¶€ ì…êµ­ì„ í—ˆê°€í•  í•„ìš”ê°€ ìˆë‹¤ê³  ì¸ì •ë˜ëŠ” ì‚¬ëŒì— ëŒ€í•´ì„œëŠ” ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì¡°ê±´ë¶€ ì…êµ­ì„ í—ˆê°€í•  ìˆ˜ ìˆë‹¤.",
    "22. (ì™¸êµ­ì¸ì˜ ì²´ë¥˜ ë° í™œë™ë²”ìœ„-ì œ17ì¡°)ì™¸êµ­ì¸ì€ ê·¸ ì²´ë¥˜ìê²©ê³¼ ì²´ë¥˜ê¸°ê°„ì˜ ë²”ìœ„ì—ì„œ ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•  ìˆ˜ ìˆë‹¤.",
    "23. (ì™¸êµ­ì¸ì˜ ì²´ë¥˜ ë° í™œë™ë²”ìœ„-ì œ17ì¡°)ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•˜ëŠ” ì™¸êµ­ì¸ì€ ì´ ë²• ë˜ëŠ” ë‹¤ë¥¸ ë²•ë¥ ì—ì„œ ì •í•˜ëŠ” ê²½ìš°ë¥¼ ì œì™¸í•˜ê³ ëŠ” ì •ì¹˜í™œë™ì„ í•˜ì—¬ì„œëŠ” ì•„ë‹ˆ ëœë‹¤.",
    "24. (ì™¸êµ­ì¸ì˜ ì²´ë¥˜ ë° í™œë™ë²”ìœ„-ì œ17ì¡°) ë²•ë¬´ë¶€ì¥ê´€ì€ ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•˜ëŠ” ì™¸êµ­ì¸ì´ ì •ì¹˜í™œë™ì„ í•˜ì˜€ì„ ë•Œì—ëŠ” ê·¸ ì™¸êµ­ì¸ì—ê²Œ ì„œë©´ìœ¼ë¡œ ê·¸ í™œë™ì˜ ì¤‘ì§€ëª…ë ¹ì´ë‚˜ ê·¸ ë°–ì— í•„ìš”í•œ ëª…ë ¹ì„ í•  ìˆ˜ ìˆë‹¤.",
    "25. (ì™¸êµ­ì¸ ê³ ìš©ì˜ ì œí•œ-ì œ18ì¡° 1í•­) ì™¸êµ­ì¸ì´ ëŒ€í•œë¯¼êµ­ì—ì„œ ì·¨ì—…í•˜ë ¤ë©´ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì·¨ì—…í™œë™ì„ í•  ìˆ˜ ìˆëŠ” ì²´ë¥˜ìê²©ì„ ë°›ì•„ì•¼ í•œë‹¤.",
    "26. (ì™¸êµ­ì¸ ê³ ìš©ì˜ ì œí•œ-ì œ18ì¡°) ì œ1í•­ì— ë”°ë¥¸ ì²´ë¥˜ìê²©ì„ ê°€ì§„ ì™¸êµ­ì¸ì€ ì§€ì •ëœ ê·¼ë¬´ì²˜ê°€ ì•„ë‹Œ ê³³ì—ì„œ ê·¼ë¬´í•˜ì—¬ì„œëŠ” ì•„ë‹ˆ ëœë‹¤.",
    "27. (ì™¸êµ­ì¸ ê³ ìš©ì˜ ì œí•œ-ì œ18ì¡°) ëˆ„êµ¬ë“ ì§€ ì œ1í•­ì— ë”°ë¥¸ ì²´ë¥˜ìê²©ì„ ê°€ì§€ì§€ ì•„ë‹ˆí•œ ì‚¬ëŒì„ ê³ ìš©í•˜ì—¬ì„œëŠ” ì•„ë‹ˆ ëœë‹¤.",
    "28. (ì™¸êµ­ì¸ ê³ ìš©ì˜ ì œí•œ-ì œ18ì¡°) ëˆ„êµ¬ë“ ì§€ ì œ1í•­ì— ë”°ë¥¸ ì²´ë¥˜ìê²©ì„ ê°€ì§€ì§€ ì•„ë‹ˆí•œ ì‚¬ëŒì˜ ê³ ìš©ì„ ì•Œì„ í•˜ê±°ë‚˜ ê¶Œìœ í•˜ì—¬ì„œëŠ” ì•„ë‹ˆ ëœë‹¤.",
    "29. (ì™¸êµ­ì¸ ê³ ìš©ì˜ ì œí•œ-ì œ18ì¡°) ëˆ„êµ¬ë“ ì§€ ì œ1í•­ì— ë”°ë¥¸ ì²´ë¥˜ìê²©ì„ ê°€ì§€ì§€ ì•„ë‹ˆí•œ ì‚¬ëŒì˜ ê³ ìš©ì„ ì•Œì„ í•  ëª©ì ìœ¼ë¡œ ê·¸ë¥¼ ìê¸° ì§€ë°°í•˜ì— ë‘ëŠ” í–‰ìœ„ë¥¼ í•˜ì—¬ì„œëŠ” ì•„ë‹ˆ ëœë‹¤.",
    "30. (í™œë™ë²”ìœ„ì˜ ì œí•œ-ì œ22ì¡°) ë²•ë¬´ë¶€ì¥ê´€ì€ ê³µê³µì˜ ì•ˆë…•ì§ˆì„œë‚˜ ëŒ€í•œë¯¼êµ­ì˜ ì¤‘ìš”í•œ ì´ìµì„ ìœ„í•˜ì—¬ í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•˜ë©´ ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•˜ëŠ” ì™¸êµ­ì¸ì— ëŒ€í•˜ì—¬ ê±°ì†Œ(å±…æ‰€) ë˜ëŠ” í™œë™ì˜ ë²”ìœ„ë¥¼ ì œí•œí•˜ê±°ë‚˜ ê·¸ ë°–ì— í•„ìš”í•œ ì¤€ìˆ˜ì‚¬í•­ì„ ì •í•  ìˆ˜ ìˆë‹¤.",
    "31. (ì²´ë¥˜ìê²© ë¶€ì—¬-ì œ23ì¡°) ëŒ€í•œë¯¼êµ­ì—ì„œ ì¶œìƒí•œ ì™¸êµ­ì¸ì€ ì¶œìƒí•œ ë‚ ë¶€í„° 90ì¼ ì´ë‚´ì—, ì²´ë¥˜ ì¤‘ ëŒ€í•œë¯¼êµ­ êµ­ì ì„ ìƒì‹¤í•˜ê±°ë‚˜ ì´íƒˆí•˜ëŠ” ë“± ê·¸ ë°–ì˜ ì‚¬ìœ ê°€ ë°œìƒí•œ ì™¸êµ­ì¸ì€ ì‚¬ìœ  ë°œìƒì¼ë¡œë¶€í„° 60ì¼ ì´ë‚´ì— ì œ10ì¡°ì— ë”°ë¥¸ ì²´ë¥˜ìê²©ì„ ê°€ì§€ì§€ ëª»í•˜ê²Œ ëœ ê²½ìš° ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì²´ë¥˜ìê²©ì„ ë°›ì•„ì•¼ í•˜ë©°, ê·¸ ë¶€ì—¬ì˜ ì‹¬ì‚¬ ê¸°ì¤€ì€ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "32. (ì²´ë¥˜ìê²© ë³€ê²½ í—ˆê°€-ì œ24ì¡°)ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•˜ëŠ” ì™¸êµ­ì¸ì´ ê·¸ ì²´ë¥˜ìê²©ê³¼ ë‹¤ë¥¸ ì²´ë¥˜ìê²©ì— í•´ë‹¹í•˜ëŠ” í™œë™ì„ í•˜ë ¤ë©´ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ë¯¸ë¦¬ ë²•ë¬´ë¶€ì¥ê´€ì˜ ì²´ë¥˜ìê²© ë³€ê²½í—ˆê°€ë¥¼ ë°›ì•„ì•¼ í•œë‹¤.",
    "33. (ì²´ë¥˜ê¸°ê°„ ì—°ì¥ í—ˆê°€-ì œ25ì¡°)ì™¸êµ­ì¸ì´ ì²´ë¥˜ê¸°ê°„ì„ ì´ˆê³¼í•˜ì—¬ ê³„ì† ì²´ë¥˜í•˜ë ¤ë©´ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì²´ë¥˜ê¸°ê°„ì´ ëë‚˜ê¸° ì „ì— ë²•ë¬´ë¶€ì¥ê´€ì˜ ì²´ë¥˜ê¸°ê°„ ì—°ì¥í—ˆê°€ë¥¼ ë°›ì•„ì•¼ í•œë‹¤.",
    "34. (ê²°í˜¼ì´ë¯¼ì ë“±ì— ëŒ€í•œ íŠ¹ì¹™-ì œ25ì¡°ì˜2) ë²•ë¬´ë¶€ì¥ê´€ì€ ê°€ì •í­ë ¥, ì„±í­ë ¥ë²”ì£„, ì•„ë™í•™ëŒ€ë²”ì£„ ë˜ëŠ” ì¸ì‹ ë§¤ë§¤ ë“± í”¼í•´ë¥¼ ì´ìœ ë¡œ ë²•ì›ì˜ ì¬íŒ, ìˆ˜ì‚¬ê¸°ê´€ì˜ ìˆ˜ì‚¬ ë˜ëŠ” ê·¸ ë°–ì˜ ë²•ë¥ ì— ë”°ë¥¸ ê¶Œë¦¬êµ¬ì œ ì ˆì°¨ê°€ ì§„í–‰ ì¤‘ì¸ ì™¸êµ­ì¸(ê°€ì •í­ë ¥ í”¼í•´ì˜ ê²½ìš° ëŒ€í•œë¯¼êµ­ êµ­ë¯¼ì˜ ë°°ìš°ìì¸ ì™¸êµ­ì¸, ì•„ë™í•™ëŒ€ì˜ ê²½ìš° ì•„ë™ ë° ë³´í˜¸ì)ì´ ì²´ë¥˜ê¸°ê°„ ì—°ì¥í—ˆê°€ë¥¼ ì‹ ì²­í•˜ëŠ” ê²½ìš° í•´ë‹¹ ì ˆì°¨ê°€ ì¢…ë£Œí•  ë•Œê¹Œì§€ ì—°ì¥ì„ í—ˆê°€í•  ìˆ˜ ìˆìœ¼ë©°, ê·¸ ê¸°ê°„ ë§Œë£Œ ì´í›„ì—ë„ í”¼í•´ íšŒë³µ ë“±ì„ ìœ„í•´ í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•˜ë©´ ì¶”ê°€ë¡œ ì²´ë¥˜ê¸°ê°„ ì—°ì¥ì„ í—ˆê°€í•  ìˆ˜ ìˆë‹¤.",
    "35. (ì—¬ê¶Œë“±ì˜ íœ´ëŒ€ì˜ë¬´-ì œ27ì¡°)ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•˜ëŠ” ì™¸êµ­ì¸ì€ í•­ìƒ ì—¬ê¶Œã†ì„ ì›ì‹ ë¶„ì¦ëª…ì„œã†ì™¸êµ­ì¸ì…êµ­í—ˆê°€ì„œã†ì™¸êµ­ì¸ë“±ë¡ì¦ã†ëª¨ë°”ì¼ì™¸êµ­ì¸ë“±ë¡ì¦ ë˜ëŠ” ìƒë¥™í—ˆê°€ì„œ(ì´í•˜ â€œì—¬ê¶Œë“±â€ì´ë¼ í•œë‹¤)ë¥¼ ì§€ë‹ˆê³  ìˆì–´ì•¼ í•œë‹¤. ë‹¤ë§Œ, 17ì„¸ ë¯¸ë§Œì¸ ì™¸êµ­ì¸ì˜ ê²½ìš°ì—ëŠ” ê·¸ëŸ¬í•˜ì§€ ì•„ë‹ˆí•˜ë‹¤.",
    "36. (ì—¬ê¶Œë“±ì˜ ì œì‹œ ì˜ë¬´-ì œ27ì¡° ì œ2í•­)ì™¸êµ­ì¸ì€ ì¶œì…êµ­ê´€ë¦¬ê³µë¬´ì›ì´ë‚˜ ê¶Œí•œ ìˆëŠ” ê³µë¬´ì›ì´ ê·¸ ì§ë¬´ìˆ˜í–‰ê³¼ ê´€ë ¨í•˜ì—¬ ì—¬ê¶Œë“±ì˜ ì œì‹œë¥¼ ìš”êµ¬í•˜ë©´ ì—¬ê¶Œë“±ì„ ì œì‹œí•˜ì—¬ì•¼ í•œë‹¤.",
    "37. (ì¶œêµ­ì‹¬ì‚¬-ì œ28ì¡°)ì™¸êµ­ì¸ì´ ì¶œêµ­í•  ë•Œì—ëŠ” ìœ íš¨í•œ ì—¬ê¶Œì„ ê°€ì§€ê³  ì¶œêµ­í•˜ëŠ” ì¶œì…êµ­í•­ì—ì„œ ì¶œì…êµ­ê´€ë¦¬ê³µë¬´ì›ì˜ ì¶œêµ­ì‹¬ì‚¬ë¥¼ ë°›ì•„ì•¼ í•œë‹¤.",
    "38. (ì¶œêµ­ê¸ˆì§€-ì œ4ì¡° 1í•­)ë²•ë¬´ë¶€ì¥ê´€ì€ í˜•ì‚¬ì¬íŒ ê³„ì† ì¤‘ì¸ ì‚¬ëŒ, ì§•ì—­í˜•ì´ë‚˜ ê¸ˆê³ í˜• ì§‘í–‰ì´ ëë‚˜ì§€ ì•Šì€ ì‚¬ëŒ, ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ê¸ˆì•¡ ì´ìƒì˜ ë²Œê¸ˆÂ·ì¶”ì§•ê¸ˆ ë˜ëŠ” êµ­ì„¸Â·ê´€ì„¸Â·ì§€ë°©ì„¸ë¥¼ ì •ë‹¹í•œ ì‚¬ìœ  ì—†ì´ ë‚©ë¶€ ê¸°í•œê¹Œì§€ ë‚´ì§€ ì•Šì€ ì‚¬ëŒ, ã€Œì–‘ìœ¡ë¹„ ì´í–‰í™•ë³´ ë° ì§€ì›ì— ê´€í•œ ë²•ë¥ ã€ì— ë”°ë¥¸ ì–‘ìœ¡ë¹„ ì±„ë¬´ì ì¤‘ ì‹¬ì˜ã†ì˜ê²°ì„ ê±°ì¹œ ì‚¬ëŒ, ã€Œê·¼ë¡œê¸°ì¤€ë²•ã€ì— ë”°ë¼ ëª…ë‹¨ì´ ê³µê°œëœ ì²´ë¶ˆì‚¬ì—…ì£¼, ê·¸ë¦¬ê³  ê·¸ ë°–ì— ëŒ€í•œë¯¼êµ­ì˜ ì´ìµì´ë‚˜ ê³µê³µì˜ ì•ˆì „ ë˜ëŠ” ê²½ì œì§ˆì„œë¥¼ í•´ì¹  ìš°ë ¤ê°€ ìˆì–´ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì¶œêµ­ì´ ì ë‹¹í•˜ì§€ ì•Šë‹¤ê³  ì •í•˜ëŠ” ì‚¬ëŒì— ëŒ€í•˜ì—¬ 6ê°œì›” ì´ë‚´ì˜ ê¸°ê°„ì„ ì •í•˜ì—¬ ì¶œêµ­ì„ ê¸ˆì§€í•  ìˆ˜ ìˆë‹¤.",
    "39. (ì¶œêµ­ê¸ˆì§€-ì œ4ì¡° 2í•­)ë²•ë¬´ë¶€ì¥ê´€ì€ ë²”ì£„ ìˆ˜ì‚¬ë¥¼ ìœ„í•´ ì¶œêµ­ì´ ì ë‹¹í•˜ì§€ ì•Šë‹¤ê³  ì¸ì •ë˜ëŠ” ì‚¬ëŒì— ëŒ€í•˜ì—¬ëŠ” 1ê°œì›” ì´ë‚´ì˜ ê¸°ê°„ì„ ì •í•˜ì—¬ ì¶œêµ­ì„ ê¸ˆì§€í•  ìˆ˜ ìˆìœ¼ë‚˜, ì†Œì¬ë¥¼ ì•Œ ìˆ˜ ì—†ê±°ë‚˜ ë„ì£¼ ë“± íŠ¹ë³„í•œ ì‚¬ìœ ë¡œ ìˆ˜ì‚¬ ì§„í–‰ì´ ì–´ë ¤ìš´ ì‚¬ëŒì€ 3ê°œì›” ì´ë‚´ë¡œ, ê¸°ì†Œì¤‘ì§€ ë˜ëŠ” ìˆ˜ì‚¬ì¤‘ì§€ ìƒíƒœì—ì„œ ì²´í¬ì˜ì¥ ë˜ëŠ” êµ¬ì†ì˜ì¥ì´ ë°œë¶€ëœ ì‚¬ëŒì€ ì˜ì¥ ìœ íš¨ê¸°ê°„ ì´ë‚´ë¡œ ê·¸ ê¸°ê°„ì„ ì •í•œë‹¤.",
    "40. (ì¬ì…êµ­í—ˆê°€-ì œ30ì¡°) ë²•ë¬´ë¶€ì¥ê´€ì€ ì™¸êµ­ì¸ë“±ë¡ì„ í•˜ê±°ë‚˜ ë“±ë¡ì´ ë©´ì œëœ ì™¸êµ­ì¸ì´ ì²´ë¥˜ ê¸°ê°„ ë‚´ì— ì¶œêµ­í–ˆë‹¤ê°€ ì¬ì…êµ­í•˜ë ¤ëŠ” ê²½ìš° ì‹ ì²­ì„ ë°›ì•„ ì¬ì…êµ­ì„ í—ˆê°€í•  ìˆ˜ ìˆìœ¼ë©°, ì´ í—ˆê°€ëŠ” 1íšŒ ì…êµ­ ê°€ëŠ¥í•œ ë‹¨ìˆ˜ì¬ì…êµ­í—ˆê°€ì™€ 2íšŒ ì´ìƒ ì…êµ­ ê°€ëŠ¥í•œ ë³µìˆ˜ì¬ì…êµ­í—ˆê°€ë¡œ êµ¬ë¶„ë˜ì§€ë§Œ, ì˜ì£¼ìê²©ìë‚˜ ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ì¬ì…êµ­í—ˆê°€ ë©´ì œ ì‚¬ìœ ê°€ ìˆëŠ” ì‚¬ëŒì— ëŒ€í•´ì„œëŠ” í—ˆê°€ë¥¼ ë©´ì œí•  ìˆ˜ ìˆë‹¤.",
    "41. (ì¬ì…êµ­í—ˆê°€-ì¬30ì¡°)ì™¸êµ­ì¸ì´ ì§ˆë³‘ ë“± ë¶€ë“ì´í•œ ì‚¬ìœ ë¡œ í—ˆê°€ ê¸°ê°„ ë‚´ì— ì¬ì…êµ­í•  ìˆ˜ ì—†ì„ ë•Œì—ëŠ” ê¸°ê°„ì´ ëë‚˜ê¸° ì „ì— ë²•ë¬´ë¶€ì¥ê´€ì˜ ì—°ì¥ í—ˆê°€ë¥¼ ë°›ì•„ì•¼ í•˜ë©°, ë²•ë¬´ë¶€ì¥ê´€ì€ ì´ ê¸°ê°„ ì—°ì¥ í—ˆê°€ ê¶Œí•œì„ ëŒ€í†µë ¹ë ¹ì— ë”°ë¼ ì¬ì™¸ê³µê´€ì˜ ì¥ì—ê²Œ ìœ„ì„í•  ìˆ˜ ìˆê³ , ì¬ì…êµ­ í—ˆê°€ ë° ê·¸ ê¸°ê°„ ì—°ì¥, ë©´ì œì— ê´€í•œ ê¸°ì¤€ê³¼ ì ˆì°¨ëŠ” ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•œë‹¤.",
    "42. (ì™¸êµ­ì¸ë“±ë¡-ì œ31ì¡° ì œ1í•­)ì™¸êµ­ì¸ì´ ì…êµ­í•œ ë‚ ë¶€í„° 90ì¼ì„ ì´ˆê³¼í•˜ì—¬ ëŒ€í•œë¯¼êµ­ì— ì²´ë¥˜í•˜ë ¤ë©´ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì…êµ­í•œ ë‚ ë¶€í„° 90ì¼ ì´ë‚´ì— ê·¸ì˜ ì²´ë¥˜ì§€ë¥¼ ê´€í• í•˜ëŠ” ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì—ê²Œ ì™¸êµ­ì¸ë“±ë¡ì„ í•˜ì—¬ì•¼ í•œë‹¤. ë‹¤ë§Œ, ë‹¤ìŒ ê° í˜¸ì˜ ì–´ëŠ í•˜ë‚˜ì— í•´ë‹¹í•˜ëŠ” ì™¸êµ­ì¸ì˜ ê²½ìš°ì—ëŠ” ê·¸ëŸ¬í•˜ì§€ ì•„ë‹ˆí•˜ë‹¤",
    "43. (ì™¸êµ­ì¸ë“±ë¡ë²ˆí˜¸ ë¶€ì—¬-ì œ31ì¡° ì œ5í•­)ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì€ ì œ1í•­ë¶€í„° ì œ4í•­ê¹Œì§€ì˜ ê·œì •ì— ë”°ë¼ ì™¸êµ­ì¸ë“±ë¡ì„ í•œ ì‚¬ëŒì—ê²ŒëŠ” ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°©ë²•ì— ë”°ë¼ ê°œì¸ë³„ë¡œ ê³ ìœ í•œ ë“±ë¡ë²ˆí˜¸(ì´í•˜ â€œì™¸êµ­ì¸ë“±ë¡ë²ˆí˜¸â€ë¼ í•œë‹¤)ë¥¼ ë¶€ì—¬í•˜ì—¬ì•¼ í•œë‹¤.",
    "44. (ì™¸êµ­ì¸ ë“±ë¡ì‚¬í•­-ì œ32ì¡°) ì™¸êµ­ì¸ë“±ë¡ì‚¬í•­ì€ ì„±ëª…, ì„±ë³„, ìƒë…„ì›”ì¼ ë° êµ­ì , ì—¬ê¶Œì˜ ë²ˆí˜¸Â·ë°œê¸‰ì¼ì ë° ìœ íš¨ê¸°ê°„, ê·¼ë¬´ì²˜ì™€ ì§ìœ„ ë˜ëŠ” ë‹´ë‹¹ ì—…ë¬´, ë³¸êµ­ì˜ ì£¼ì†Œì™€ êµ­ë‚´ ì²´ë¥˜ì§€, ì²´ë¥˜ìê²©ê³¼ ì²´ë¥˜ ê¸°ê°„, ê·¸ë¦¬ê³  ì´ ì™¸ì— ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ì‚¬í•­ë“¤ë¡œ êµ¬ì„±ëœë‹¤.",
    "45. (ì™¸êµ­ì¸ ë“±ë¡ì¦ì˜ ë°œê¸‰-ì œ33ì¡° ì œ1í•­)ì œ31ì¡°ì— ë”°ë¼ ì™¸êµ­ì¸ë“±ë¡ì„ ë°›ì€ ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì€ ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ê·¸ ì™¸êµ­ì¸ì—ê²Œ ì™¸êµ­ì¸ë“±ë¡ì¦ì„ ë°œê¸‰í•˜ì—¬ì•¼ í•œë‹¤. ë‹¤ë§Œ, ê·¸ ì™¸êµ­ì¸ì´ 17ì„¸ ë¯¸ë§Œì¸ ê²½ìš°ì—ëŠ” ë°œê¸‰í•˜ì§€ ì•„ë‹ˆí•  ìˆ˜ ìˆë‹¤.",
    "46. (ëª¨ë°”ì¼ì™¸êµ­ì¸ë“±ë¡ì¦ ë°œê¸‰-ì œ33`ì¡°6í•­) ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì€ ì œ1í•­ì— ë”°ë¼ ì™¸êµ­ì¸ë“±ë¡ì¦ì„ ë°œê¸‰ë°›ì€ ì™¸êµ­ì¸ì—ê²Œ ì™¸êµ­ì¸ë“±ë¡ì¦ê³¼ ë™ì¼í•œ íš¨ë ¥ì„ ê°€ì§„ ëª¨ë°”ì¼ì™¸êµ­ì¸ë“±ë¡ì¦(ã€Œì „ê¸°í†µì‹ ì‚¬ì—…ë²•ã€ ì œ2ì¡°ì œ20í˜¸ì— ë”°ë¥¸ ì´ë™í†µì‹ ë‹¨ë§ì¥ì¹˜ì— ì•”í˜¸í™”ëœ í˜•íƒœë¡œ ì„¤ì¹˜ëœ ì™¸êµ­ì¸ë“±ë¡ì¦ì„ ë§í•œë‹¤. ì´í•˜ ê°™ë‹¤)ì„ ë°œê¸‰í•  ìˆ˜ ìˆë‹¤.",
    "47. (ì™¸êµ­ì¸ë“±ë¡ì‚¬í•­ì˜ ë³€ê²½ì‹ ê³ -ì œ35ì¡°)ì œ31ì¡°ì— ë”°ë¼ ë“±ë¡ì„ í•œ ì™¸êµ­ì¸ì€ ì„±ëª…, ì„±ë³„, ìƒë…„ì›”ì¼ ë° êµ­ì , ì—¬ê¶Œì˜ ë²ˆí˜¸, ë°œê¸‰ì¼ì ë° ìœ íš¨ê¸°ê°„, ê·¸ë¦¬ê³  ê·¸ ë°–ì— ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ì‚¬í•­ì´ ë³€ê²½ë˜ì—ˆì„ ê²½ìš° ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ 15ì¼ ì´ë‚´ì— ì²´ë¥˜ì§€ ê´€í•  ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì—ê²Œ ì™¸êµ­ì¸ë“±ë¡ì‚¬í•­ ë³€ê²½ì‹ ê³ ë¥¼ í•´ì•¼ í•œë‹¤.",
    "48. (ì²´ë¥˜ì§€ ë³€ê²½ì˜ ì‹ ê³ -ì œ36ì¡° ì œ1í•­)ì œ31ì¡°ì— ë”°ë¼ ë“±ë¡ì„ í•œ ì™¸êµ­ì¸ì´ ì²´ë¥˜ì§€ë¥¼ ë³€ê²½í•˜ì˜€ì„ ë•Œì—ëŠ” ëŒ€í†µë ¹ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì „ì…í•œ ë‚ ë¶€í„° 15ì¼ ì´ë‚´ì— ìƒˆë¡œìš´ ì²´ë¥˜ì§€ì˜ ì‹œã†êµ°ã†êµ¬ ë˜ëŠ” ìã†ë©´ã†ë™ì˜ ì¥ì´ë‚˜ ê·¸ ì²´ë¥˜ì§€ë¥¼ ê´€í• í•˜ëŠ” ì§€ë°©ì¶œì…êµ­ã†ì™¸êµ­ì¸ê´€ì„œì˜ ì¥ì—ê²Œ ì „ì…ì‹ ê³ ë¥¼ í•˜ì—¬ì•¼ í•œë‹¤.",
    "49. (ì™¸êµ­ì¸ ë“±ë¡ì¦ì˜ ë°˜ë‚©-ì œ37ì¡° ì œ1í•­) ì œ31ì¡°ì— ë”°ë¼ ë“±ë¡í•œ ì™¸êµ­ì¸ì´ ì¶œêµ­í•  ë•Œì—ëŠ” ì¶œì…êµ­ê´€ë¦¬ê³µë¬´ì›ì—ê²Œ ì™¸êµ­ì¸ë“±ë¡ì¦ì„ ë°˜ë‚©í•´ì•¼ í•˜ì§€ë§Œ, ì¬ì…êµ­í—ˆê°€ë¥¼ ë°›ê³  í—ˆê°€ê¸°ê°„ ë‚´ì— ë‹¤ì‹œ ì…êµ­í•˜ë ¤ëŠ” ê²½ìš°, ë³µìˆ˜ì‚¬ì¦ ì†Œì§€ìë‚˜ ì¬ì…êµ­í—ˆê°€ ë©´ì œëŒ€ìƒ êµ­ê°€ êµ­ë¯¼ìœ¼ë¡œì„œ ì²´ë¥˜ê¸°ê°„ ë‚´ì— ë‹¤ì‹œ ì…êµ­í•˜ë ¤ëŠ” ê²½ìš°, ë˜ëŠ” ë‚œë¯¼ì—¬í–‰ì¦ëª…ì„œë¥¼ ë°›ê³  ìœ íš¨ê¸°ê°„ ë‚´ì— ë‹¤ì‹œ ì…êµ­í•˜ë ¤ëŠ” ê²½ìš°ì—ëŠ” ê·¸ëŸ¬í•˜ì§€ ì•„ë‹ˆí•˜ë‹¤.",
    "50. (ìƒì²´ì •ë³´ì˜ ì œê³µ ì˜ë¬´-ì œ38ì¡° ì œ1í•­) ë²•ë¬´ë¶€ì¥ê´€ì€ ì œ31ì¡°ì— ë”°ë¼ ì™¸êµ­ì¸ë“±ë¡ì„ í•˜ê±°ë‚˜ ã€Œì¬ì™¸ë™í¬ì˜ ì¶œì…êµ­ê³¼ ë²•ì  ì§€ìœ„ì— ê´€í•œ ë²•ë¥ ã€ì— ë”°ë¼ êµ­ë‚´ê±°ì†Œì‹ ê³ ë¥¼ í•˜ë ¤ëŠ” 17ì„¸ ì´ìƒì¸ ì‚¬ëŒ, ì´ ë²•ì´ë‚˜ ë‹¤ë¥¸ ë²•ë¥ ì„ ìœ„ë°˜í•˜ì—¬ ì¡°ì‚¬ë¥¼ ë°›ê±°ë‚˜ ìˆ˜ì‚¬ë¥¼ ë°›ê³  ìˆëŠ” ì‚¬ëŒ, ì‹ ì›ì´ í™•ì‹¤í•˜ì§€ ì•Šì€ ì‚¬ëŒ, ë˜ëŠ” ëŒ€í•œë¯¼êµ­ì˜ ì•ˆì „ì´ë‚˜ ì´ìµ ë“±ì„ ìœ„í•˜ì—¬ ë²•ë¬´ë¶€ì¥ê´€ì´ íŠ¹íˆ í•„ìš”í•˜ë‹¤ê³  ì¸ì •í•˜ëŠ” ì‚¬ëŒì— ëŒ€í•´ì„œëŠ” ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ìƒì²´ì •ë³´ë¥¼ ì œê³µí•˜ë„ë¡ í•˜ì—¬ì•¼.",
    "51. (ì™¸êµ­ì¸ì˜ ì •ë³´ì œê³µ ì˜ë¬´-ì œ81ì¡°ì˜3 ì œ1í•­) ì œ10ì¡°ì˜2ì œ1í•­ì œ1í˜¸ì— ë”°ë¥¸ ë‹¨ê¸°ì²´ë¥˜ìê²©ì„ ê°€ì§„ ì™¸êµ­ì¸(ì´í•˜ â€œìˆ™ë°•ì™¸êµ­ì¸â€ì´ë¼ í•œë‹¤)ì€ ã€Œê°ì—¼ë³‘ì˜ ì˜ˆë°© ë° ê´€ë¦¬ì— ê´€í•œ ë²•ë¥ ã€ì— ë”°ë¥¸ ìœ„ê¸°ê²½ë³´ì˜ ë°œë ¹ ë˜ëŠ” ã€Œêµ­ë¯¼ë³´í˜¸ì™€ ê³µê³µì•ˆì „ì„ ìœ„í•œ í…ŒëŸ¬ë°©ì§€ë²•ã€ì— ë”°ë¥¸ í…ŒëŸ¬ê²½ë³´ì˜ ë°œë ¹ ë“± ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ê²½ìš°ì— í•œì •í•˜ì—¬ ë‹¤ìŒ ê° í˜¸ì˜ ì–´ëŠ í•˜ë‚˜ì— í•´ë‹¹í•˜ëŠ” ì(ì´í•˜ â€œìˆ™ë°•ì—…ìâ€ë¼ í•œë‹¤)ê°€ ê²½ì˜í•˜ëŠ” ìˆ™ë°•ì—…ì†Œì—ì„œ ë¨¸ë¬´ëŠ” ê²½ìš° ìˆ™ë°•ì—…ìì—ê²Œ ì—¬ê¶Œ ë“± ë²•ë¬´ë¶€ë ¹ìœ¼ë¡œ ì •í•˜ëŠ” ìë£Œë¥¼ ì œê³µí•˜ì—¬ì•¼ í•œë‹¤."
]

SIMILARITY_THRESHOLD = 0.4

tip_embeddings: List[np.ndarray] = []
tip_embeddings_lock = asyncio.Lock()

async def get_tip_embeddings():
    global tip_embeddings
    async with tip_embeddings_lock:
        if not tip_embeddings:
            resp = await client.embeddings.create(
                model="text-embedding-3-small",
                input=TIP_LIST
            )
            tip_embeddings = [np.array(d.embedding) for d in resp.data]
    return tip_embeddings


async def get_embedding(text: str):
    resp = await client.embeddings.create(
        model="text-embedding-3-small",
        input=text
    )
    return np.array(resp.data[0].embedding)


async def find_top_relevant_tips(question: str, top_n=3):
    embeddings = await get_tip_embeddings()
    q_emb = await get_embedding(question)
    sims = [np.dot(q_emb, t) for t in embeddings]

    idx = np.argsort(sims)[-top_n:][::-1]
    top_score = sims[idx[0]]
    tips_str = "\n".join([TIP_LIST[i] for i in idx])
    return tips_str, top_score


async def get_rag_response(question: str, relevant_tips: str) -> str:
    system_prompt = f"""
ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì¶œì…êµ­ê´€ë¦¬ë²• ë° ì²´ë¥˜í—ˆê°€ ì—…ë¬´ì— ì „ë¬¸ ì§€ì‹ì„ ê°€ì§„ 
'ì¶œì…êµ­Â·ì™¸êµ­ì¸ì •ì±… ì „ë¬¸ê°€ AI ìƒë‹´ê´€'ì…ë‹ˆë‹¤.

ë‹¹ì‹ ì˜ ë‹µë³€ì€ ë°˜ë“œì‹œ ì•„ë˜ì˜ 'ì°¸ê³  ìë£Œ(íŒ ëª©ë¡)'ì— ê¸°ë°˜í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.
(ì¦‰, TIP_LISTì— ì—†ëŠ” ë‚´ìš©ì€ ë‹¨ì •ì ìœ¼ë¡œ ë§í•˜ì§€ ë§ê³ , "ì°¸ê³  ìë£Œì˜ ë²”ìœ„ ë‚´ì—ì„œâ€¦"ë¼ê³  ì œí•œì ìœ¼ë¡œ í‘œí˜„)

--- ì°¸ê³  ìë£Œ(í†µí•©ì‹ ì²­ì„œ ê´€ë ¨ TIP) ---
{relevant_tips}
-----------------------------------------

[ë‹µë³€ ê·œì¹™]

1. ë‹¹ì‹ ì˜ ì—­í• ì€ í†µí•©ì‹ ì²­ì„œ(ì™¸êµ­ì¸ë“±ë¡, ì²´ë¥˜ê¸°ê°„ ì—°ì¥, ì²´ë¥˜ìê²© ë³€ê²½/ë¶€ì—¬, ê·¼ë¬´ì²˜ ë³€ê²½Â·ì¶”ê°€, ì²´ë¥˜ì§€ ë³€ê²½ ë“±) ì‘ì„±Â·ì‹ ê³ ì™€ ê´€ë ¨ëœ ì‚¬í•­ë§Œ ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

2. ì•„ë˜ PDF ì„œì‹(í†µí•©ì‹ ì²­ì„œ/ì‹ ê³ ì„œ)ì„ ê¸°ì¤€ìœ¼ë¡œ, ì‚¬ìš©ìì˜ ì§ˆë¬¸ì´ ì–´ë–¤ í•­ëª©(application type), ì–´ë–¤ ì„œë¥˜, ì–´ë–¤ ì ˆì°¨ì™€ ê´€ë ¨ëœ ê²ƒì¸ì§€ íŒë‹¨í•˜ê³  ì•ˆë‚´í•˜ì„¸ìš”.

3. ë‹µë³€ì€ ë°˜ë“œì‹œ ì•„ë˜ ìˆœì„œë¥¼ ë”°ë¦…ë‹ˆë‹¤:
   (1) ì§ˆë¬¸ì—ì„œ íŒŒì•…í•œ í•µì‹¬ ìŸì ì„ ì •ë¦¬  
   (2) ì°¸ê³  ìë£Œ(TIP_LIST)ì— ê·¼ê±°í•˜ì—¬ ë‹µë³€  
   (3) í•„ìš”í•˜ë©´ â€œì¶”ê°€ì ìœ¼ë¡œ í†µí•©ì‹ ì²­ì„œì˜ í•´ë‹¹ í•­ëª©ì€ â€¦ì— í•´ë‹¹í•©ë‹ˆë‹¤"ì²˜ëŸ¼ ì•ˆë‚´  
   (4) ë§ˆì§€ë§‰ ì¤„ì— 'ì¶œì²˜: íŒ Në²ˆ' í˜•ì‹ìœ¼ë¡œ ê·¼ê±° ëª…ì‹œ

4. ëª¨ë¥´ë©´ ëª¨ë¥¸ë‹¤ê³  ë‹µí•˜ê³ , TIP_LISTì˜ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ” ë²•ì  íŒë‹¨ì€ í•˜ì§€ ë§ˆì„¸ìš”.
   (ì˜ˆ: í•„ìš” ì„œë¥˜, ì‹¬ì‚¬ ê¸°ì¤€, í—ˆê°€ ê°€ëŠ¥ ì—¬ë¶€ëŠ” TIP_LISTì— ê¸°ë°˜í•´ ì œí•œì ìœ¼ë¡œë§Œ ë‹µë³€)

5. ë¶ˆí•„ìš”í•œ ì‚¬ì¡±, ì¸ì‚¬ë§, ë¬¸ì¥ ì™¸ì˜ ìš”ì†ŒëŠ” ë„£ì§€ ë§ê³  ë‹µë³€ë§Œ í•˜ì„¸ìš”.

    """
    resp = await client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": question},
        ],
        temperature=0
    )
    return resp.choices[0].message.content.strip()


# --- 2. í†µí•©ì‹ ì²­ì„œ ì „ìš© AI ì¶”ì¶œê¸° ---
async def get_smart_extraction(
    client: AsyncOpenAI,
    field_id: str, 
    user_message: str, 
    question: str
) -> Dict:
    """
    [í†µí•©ì‹ ì²­ì„œ AI ìŠ¤ë§ˆíŠ¸ ì¶”ì¶œê¸°]
    'í†µí•©ì‹ ì²­ì„œ'ì˜ ë³µì¡í•œ í¼(ì²´í¬ë°•ìŠ¤, ë‚ ì§œ ë“±)ì„ ì±„ìš°ê¸° ìœ„í•´ 
    working_ai.pyì˜ í”„ë¡¬í”„íŠ¸ êµ¬ì¡°ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    
    today = datetime.date.today()
    current_year = today.year
    json_format_example = '{"status": "...", "filled_fields": {"key": "value", ...}, "skip_next_n_questions": 0, "follow_up_question": null}'
    
    # â—ï¸ [ìˆ˜ì •] ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ì˜ ì—­í•  ìˆ˜ì •
    base_system_prompt = f"""
    ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ 'ì¶œì…êµ­ê´€ë¦¬ì‚¬ë¬´ì†Œ'ì˜ ë¯¼ì› ì„œë¥˜ ì‘ì„±ì„ ë•ëŠ” ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
    ì‚¬ìš©ìì˜ ë‹µë³€ì—ì„œ 'í†µí•©ì‹ ì²­ì„œ' ì„œì‹ì— í•„ìš”í•œ í•µì‹¬ ì •ë³´ë¥¼ ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
    ì˜¤ëŠ˜ì€ {today.strftime('%Yë…„ %mì›” %dì¼')}ì…ë‹ˆë‹¤. (í˜„ì¬ ì—°ë„ëŠ” {current_year}ë…„)

    [ê·œì¹™]
    1.  `filled_fields`ì—ëŠ” í…œí”Œë¦¿(`.docx`)ì˜ ë³€ìˆ˜ëª…(field_id)ì„ keyë¡œ ì‚¬ìš©í•˜ì—¬ ì¶”ì¶œí•œ ê°’ì„ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
    2.  `skip_next_n_questions`ëŠ” ì‚¬ìš©ìì˜ ë‹µë³€ìœ¼ë¡œ ì¸í•´ ë¶ˆí•„ìš”í•´ì§„ *ë‹¤ìŒ* ì§ˆë¬¸ë“¤ì˜ 'ê°œìˆ˜'ì…ë‹ˆë‹¤. (ë¶„ê¸° ë¡œì§ì˜ í•µì‹¬)
    3.  [ìƒë…„ì›”ì¼] í˜•ì‹ì€ 'YYYY', 'MM', 'DD'ë¡œ ë¶„ë¦¬í•˜ì—¬ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
    4.  [ì„±ë³„]ì€ 'sex_m_check', 'sex_f_check' ë³€ìˆ˜ì— "â˜’" ë˜ëŠ” "â˜"ë¡œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
    5.  [ì‹ ì²­ í•­ëª©]ì€ í•´ë‹¹í•˜ëŠ” `_check` ë³€ìˆ˜ì— "â˜’"ë¥¼, ë‚˜ë¨¸ì§€ëŠ” "â˜"ë¥¼ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
    6.  [ì§ì—…]ì€ í•´ë‹¹í•˜ëŠ” `_check` ë³€ìˆ˜ì— "â˜’"ë¥¼, ë‚˜ë¨¸ì§€ëŠ” "â˜"ë¥¼ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
    7.  ë°˜ë“œì‹œ ì§€ì •ëœ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

    [JSON ë°˜í™˜ í˜•ì‹]
    {json_format_example}
    """
    
    specific_examples = ""
    
    # â—ï¸ [í•„ìˆ˜ ìˆ˜ì •] 
    # 'í†µí•©ì‹ ì²­ì„œ'ì˜ field_idì— ë§ì¶° í“¨ìƒ·(Few-Shot) ì˜ˆì‹œë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
    # íŠ¹íˆ ì²´í¬ë°•ìŠ¤ í•„ë“œë“¤ì€ ë°˜ë“œì‹œ ì˜ˆì‹œê°€ í•„ìš”í•©ë‹ˆë‹¤.
    
    # [ìƒë…„ì›”ì¼] -> ë…„, ì›”, ì¼ë¡œ ìª¼ê°œê¸°
    if field_id == "birth":
        specific_examples = f"""
        [ì˜ˆì‹œ 1: ë‚ ì§œ í˜•ì‹í™” (YYYY, MM, DDë¡œ ë¶„ë¦¬)]
        question: "{question}"
        user_message: "1990ë…„ 1ì›” 30ì¼ì…ë‹ˆë‹¤."
        AI: {{"status": "success", "filled_fields": {{"birth_yyyy": "1990", "birth_mm": "01", "birth_dd": "30"}}, "skip_next_n_questions": 0, "follow_up_question": null}}
        """
        
    # [ì„±ë³„] -> ì²´í¬ë°•ìŠ¤ë¡œ ë³€í™˜
    elif field_id == "sex":
        specific_examples = """
        [ì˜ˆì‹œ 1: 'ë‚¨' ì„ íƒ]
        question: "ì„±ë³„ì„ ì•Œë ¤ì£¼ì„¸ìš”. (ë‚¨ / ì—¬)"
        user_message: "ë‚¨ìì…ë‹ˆë‹¤"
        AI: {{"status": "success", "filled_fields": {{"sex_m_check": "â˜’", "sex_f_check": "â˜"}}, "skip_next_n_questions": 0, "follow_up_question": null}}

        [ì˜ˆì‹œ 2: 'ì—¬' ì„ íƒ]
        question: "ì„±ë³„ì„ ì•Œë ¤ì£¼ì„¸ìš”. (ë‚¨ / ì—¬)"
        user_message: "ì—¬ì"
        AI: {{"status": "success", "filled_fields": {{"sex_m_check": "â˜", "sex_f_check": "â˜’"}}, "skip_next_n_questions": 0, "follow_up_question": null}}
        """
  # [ë¶„ê¸° 1: ì‹ ì²­ í•­ëª©]
    elif field_id == "application_type":
        # â—ï¸ [ì¤‘ìš”] ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤íŠ¸(1ë‹¨ê³„)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ 'ê±´ë„ˆë›¸ ì§ˆë¬¸ì˜ ê°œìˆ˜'ë¥¼ ì •í™•íˆ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤.
        # ì˜ˆ: 'ì²´ë¥˜ìê²© ë³€ê²½/ë¶€ì—¬/ì™¸í™œë™í—ˆê°€' ì§ˆë¬¸(3ê°œ)
        #     'ì§ì—…' ì§ˆë¬¸(1ê°œ)
        #     'í•™ìƒ' ì§ˆë¬¸(3ê°œ)
        #     'ê·¼ë¬´ì' ì§ˆë¬¸(4ê°œ)
        #     'ê·¼ë¬´ì²˜ ë³€ê²½' ì§ˆë¬¸(2ê°œ)
        # ...
        # (ì´ ì˜ˆì‹œì—ì„œëŠ” 'í¬ë§ ìê²©' ê´€ë ¨ ì§ˆë¬¸ 3ê°œë¥¼ ê±´ë„ˆë›´ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤)
        skip_count_for_simple_app = 3 
        
        specific_examples = f"""
        [í…œí”Œë¦¿ ë³€ìˆ˜ëª… ëª©ë¡]
        "app_reg_check", "app_reissue_check", "app_ext_check", "app_change_check", "app_grant_check", "app_other_check", ... (ê¸°íƒ€ ëª¨ë“  ì‹ ì²­ ë³€ìˆ˜)

        [ì˜ˆì‹œ 1: 'ì™¸êµ­ì¸ ë“±ë¡' ì„ íƒ (í¬ë§ ìê²© ì§ˆë¬¸ 3ê°œ ìŠ¤í‚µ)]
        question: "{question}"
        user_message: "ì™¸êµ­ì¸ ë“±ë¡ì´ìš”"
        AI: {{"status": "success", "filled_fields": {{"app_reg_check": "â˜’", "app_reissue_check": "â˜", "app_change_check": "â˜", "app_grant_check": "â˜", "app_other_check": "â˜", ...}}, "skip_next_n_questions": {skip_count_for_simple_app}, "follow_up_question": null}}

        [ì˜ˆì‹œ 2: 'ì²´ë¥˜ìê²© ë³€ê²½í—ˆê°€' ì„ íƒ (ë‹¤ìŒ 'í¬ë§ ìê²©' ì§ˆë¬¸ìœ¼ë¡œ ì´ë™)]
        question: "{question}"
        user_message: "ì²´ë¥˜ìê²© ë³€ê²½í—ˆê°€ ì‹ ì²­í• ê²Œìš”"
        AI: {{"status": "success", "filled_fields": {{"app_reg_check": "â˜", "app_reissue_check": "â˜", "app_change_check": "â˜’", "app_grant_check": "â˜", "app_other_check": "â˜", ...}}, "skip_next_n_questions": 0, "follow_up_question": null}}
        """

    # [ë¶„ê¸° 2: ì§ì—…]
    elif field_id == "occupation_type":
        # â—ï¸ [ì¤‘ìš”] ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤íŠ¸(1ë‹¨ê³„)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê±´ë„ˆë›¸ ì§ˆë¬¸ ê°œìˆ˜ ê³„ì‚°
        # ì˜ˆ: 'í•™ìƒ' ì§ˆë¬¸(3ê°œ), 'ê·¼ë¬´ì' ì§ˆë¬¸(4ê°œ), 'ê·¼ë¬´ì²˜ ë³€ê²½' ì§ˆë¬¸(2ê°œ)
        student_q_count = 3
        worker_q_count = 4
        new_worker_q_count = 2
        
        specific_examples = f"""
        [í…œí”Œë¦¿ ë³€ìˆ˜ëª… ëª©ë¡]
        "occ_student_check", "occ_worker_check", "occ_other_check"

        [ì˜ˆì‹œ 1: 'í•™ìƒ' ì„ íƒ (ê·¼ë¬´ì ê´€ë ¨ ì§ˆë¬¸ 4+2=6ê°œ ìŠ¤í‚µ)]
        question: "{question}"
        user_message: "ì € í•™ìƒì´ì—ìš”"
        AI: {{"status": "success", "filled_fields": {{"occ_student_check": "â˜’", "occ_worker_check": "â˜", "occ_other_check": "â˜"}}, "skip_next_n_questions": {worker_q_count + new_worker_q_count}, "follow_up_question": null}}

        [ì˜ˆì‹œ 2: 'ê·¼ë¬´ì' ì„ íƒ (í•™ìƒ ê´€ë ¨ ì§ˆë¬¸ 3ê°œ ìŠ¤í‚µ)]
        question: "{question}"
        user_message: "íšŒì‚¬ ë‹¤ë‹ˆê³  ìˆì–´ìš”"
        AI: {{"status": "success", "filled_fields": {{"occ_student_check": "â˜", "occ_worker_check": "â˜’", "occ_other_check": "â˜"}}, "skip_next_n_questions": {student_q_count}, "follow_up_question": null}}
        """
        
    # [ê¸°ë³¸ í…ìŠ¤íŠ¸] ì˜ˆì‹œ
    else: 
        specific_examples = f"""
        [ì˜ˆì‹œ 1: ì¼ë°˜ í…ìŠ¤íŠ¸ ì¶”ì¶œ]
        question: "{question}"
        user_message: "ì„±ì€ PARKì…ë‹ˆë‹¤."
        AI: {{"status": "success", "filled_fields": {{"{field_id}": "PARK"}}, "skip_next_n_questions": 0, "follow_up_question": null}}
        """

    # --- (ì´í•˜ API í˜¸ì¶œ ë¡œì§ì€ working_ai.pyì™€ ë™ì¼) ---
    system_prompt_with_examples = f"{base_system_prompt}\n--- [í•„ë“œë³„ í“¨ìƒ·(Few-Shot) ì˜ˆì‹œ] ---\n{specific_examples}"
    
    try:
        response = await client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": system_prompt_with_examples},
                {"role": "user", "content": f"question: \"{question}\"\nuser_message: \"{user_message}\""},
            ],
            temperature=0.0,
            response_format={"type": "json_object"}, 
        )
        
        ai_response_str = response.choices[0].message.content
        ai_response_json = json.loads(ai_response_str)
        return ai_response_json
    except Exception as e:
        print(f"OpenAI (get_smart_extraction - foreign_app) API call failed: {e}")
        # ì‹¤íŒ¨ ì‹œ ë¡¤ë°± (ë‹¨ìˆœ ê°’ ì €ì¥)
        return {
            "status": "success", 
            "filled_fields": {field_id: user_message}, 
            "skip_next_n_questions": 0,
            "follow_up_question": None
        }

# --- 3. í†µí•©ì‹ ì²­ì„œ ì „ìš© "ë‹¤ìŒ ì§ˆë¬¸ ì°¾ê¸°" ë¡œì§ ---
# (ì´ ë¡œì§ì€ AIê°€ ìŠ¤í‚µì„ ë‹´ë‹¹í•˜ë¯€ë¡œ, 'working_ai.py'ì™€ ê±°ì˜ ë™ì¼í•˜ê²Œ ìœ ì§€)
def find_next_question(
    current_content: Dict[str, Any]
) -> Tuple[Optional[Dict], int]:
    """
    'í†µí•©ì‹ ì²­ì„œ' ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒì— ë¬¼ì–´ë³¼ ì§ˆë¬¸(item)ê³¼ ì¸ë±ìŠ¤(index)ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    scenario = CONTRACT_SCENARIO
    
    current_question_item: Optional[Dict] = None
    current_question_index = -1 

    for i, item in enumerate(scenario):
        field_id = item["field_id"]
        
        # ==========================
        # (1) ìƒë…„ì›”ì¼ íŠ¹ìˆ˜ ì²˜ë¦¬
        # ==========================
        if field_id == "birth":
            if all(k in current_content for k in ["birth_yyyy", "birth_mm", "birth_dd"]):
                continue  # ì„¸ ê°’ ëª¨ë‘ ìˆìœ¼ë©´ 'ì±„ì›Œì§'ìœ¼ë¡œ ê°„ì£¼
            
        # ==========================
        # (2) ê¸°ë³¸ í•„ë“œ í™•ì¸
        # ==========================
        if field_id in current_content:
            continue
        
        # ==========================
        # (3) ì²´í¬ë°•ìŠ¤í˜• í•­ëª©ë“¤ ì²˜ë¦¬
        # ==========================
        if field_id == "sex" and ("sex_m_check" in current_content or "sex_f_check" in current_content):
            continue
        if field_id == "application_type" and (
            "app_reg_check" in current_content or "app_change_check" in current_content
        ):
            continue
        if field_id == "occupation_type" and (
            "occ_student_check" in current_content or "occ_worker_check" in current_content
        ):
            continue

        # ==========================
        # (4) ë‹¤ìŒ ì§ˆë¬¸ í™•ì •
        # ==========================
        current_question_index = i
        current_question_item = item
        break
    
    # ëª¨ë“  ì§ˆë¬¸ì„ ë‹¤ ì±„ìš´ ê²½ìš°
    if current_question_item is None:
        current_question_index = len(scenario)

    return current_question_item, current_question_index

async def process_message(
    db: AsyncSession,
    contract,
    message: str
) -> schemas.ChatResponse:

    content = contract.content or {}

    # âœ… 1) ë‹¤ìŒ ì§ˆë¬¸ ì°¾ê¸°
    current_item, current_index = find_next_question(content)

    # âœ… 2) ì•„ë¬´ ì…ë ¥ ì—†ìœ¼ë©´ "ì‹œì‘/ì¬ê°œ"
    if not message.strip():
        if current_item:
            return schemas.ChatResponse(
                reply=current_item["question"],
                updated_field=None,
                is_finished=False,
                full_contract_data=content
            )
        else:
            return schemas.ChatResponse(
                reply="ëª¨ë“  í•­ëª©ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì¶”ê°€ ì§ˆë¬¸ì´ ìˆë‚˜ìš”?",
                updated_field=None,
                is_finished=True,
                full_contract_data=content
            )

    # âœ… 3) RAG ì—¬ë¶€ íŒë‹¨
    tips, score = await find_top_relevant_tips(message)
    is_legal_question = score >= SIMILARITY_THRESHOLD

    if is_legal_question:
        rag = await get_rag_response(message, tips)

        follow = (
            f"\n\nì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.\n{current_item['question']}"
            if current_item else "\n\nê³„ì•½ì„œ ì‘ì„±ì„ ëª¨ë‘ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤."
        )

        return schemas.ChatResponse(
            reply=rag + follow,
            updated_field=None,
            is_finished=(current_item is None),
            full_contract_data=content
        )

    # âœ… 4) í¼ ë‹µë³€ ì²˜ë¦¬
    if not current_item:
        return schemas.ChatResponse(
            reply="ëª¨ë“  í•­ëª©ì´ ì´ë¯¸ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤!",
            updated_field=None,
            is_finished=True,
            full_contract_data=content
        )

    # ì‹¤ì œ í•„ë“œ ì²˜ë¦¬
    ai = await get_smart_extraction(
        client,
        current_item["field_id"],
        message,
        current_item["question"]
    )

    # âœ… AIê°€ ë°˜í™˜í•œ filled_fields ì ìš©
    new_fields = ai.get("filled_fields", {})
    content.update(new_fields)

    # âœ… skip_next_n_questions ì ìš©
    skip_n = ai.get("skip_next_n_questions", 0)
    for _ in range(skip_n):
        _, idx = find_next_question(content)
        if idx < len(CONTRACT_SCENARIO):
            content[CONTRACT_SCENARIO[idx]["field_id"]] = "__SKIPPED__"

    # âœ… follow-up ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    if ai.get("status") == "clarify":
        return schemas.ChatResponse(
            reply=ai["follow_up_question"],
            updated_field=None,
            is_finished=False,
            full_contract_data=content
        )

       # âœ… ë‹¤ìŒ ì§ˆë¬¸ ì°¾ê¸°
    next_item, _ = find_next_question(content)

    # new_fields ì— ê°’ì´ ìˆì„ ë•Œ, UpdatedField ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
    def make_updated_field_list(fields: Dict[str, Any]) -> Optional[List[schemas.UpdatedField]]:
        if not fields:
            return None
        lst: List[schemas.UpdatedField] = []
        for k, v in fields.items():
            # schemas.UpdatedField ëª¨ë¸ì„ ì§ì ‘ ìƒì„±í•´ì„œ íƒ€ì… ì•ˆì „ì„± í™•ë³´
            lst.append(schemas.UpdatedField(field_id=k, value=v))
        return lst

    updated_field_list = make_updated_field_list(new_fields)

    if next_item:
        return schemas.ChatResponse(
            reply=next_item["question"],
            updated_field=updated_field_list,   # ì´ì œ í•­ìƒ ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” None
            is_finished=False,
            full_contract_data=content
        )

    else:
        # ëª¨ë“  í•­ëª© ì‘ì„± ì™„ë£Œ ìƒíƒœ
        return schemas.ChatResponse(
            reply="ëª¨ë“  í•­ëª©ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.",
            updated_field=updated_field_list,   # ë§ˆì§€ë§‰ì— ì—…ë°ì´íŠ¸ëœ í•„ë“œ(ìˆìœ¼ë©´ ë¦¬ìŠ¤íŠ¸), ì—†ìœ¼ë©´ None
            is_finished=True,
            full_contract_data=content
        )


# -----------------------------------------------------------
# âœ… 5. DOCX ë Œë”ë§
# -----------------------------------------------------------
TEMPLATE_FILE = "foreign.docx"

'''async def render_docx(contract):
    # 1) ê²½ë¡œ ì¡°í•© ë° ì •ê·œí™” (ì ˆëŒ€ ê²½ë¡œ)
    current_dir = Path(__file__).resolve().parent
    template_path = (current_dir / ".." / ".." / "templates" / TEMPLATE_FILE).resolve()

    # 2) ë””ë²„ê·¸ ì¶œë ¥
    print("ğŸ“‚ Using template path:", str(template_path))
    print("  - cwd:", os.getcwd())
    try:
        stat = template_path.stat()
        print(f"  - exists: True, size: {stat.st_size} bytes, mode: {oct(stat.st_mode)}")
    except FileNotFoundError:
        print("  - exists: False")
    except Exception as e:
        print("  - stat error:", repr(e))

    # 3) ì§ì ‘ ì—´ì–´ë³´ê¸°(ë°”ì´ë„ˆë¦¬ë¡œ ì½ê¸° ì‹œë„)
    try:
        with open(template_path, "rb") as f:
            head = f.read(4)
        print("  - head bytes:", head)
    except Exception as e:
        print("  - open error:", repr(e))

    # 4) íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì²´í¬ (ëª…í™•í•œ ì—ëŸ¬)
    if not template_path.exists():
        raise FileNotFoundError(f"Template not found at: {template_path}")

    # 5) íŒŒì¼ í˜•ì‹ ê°„ë‹¨ ê²€ì‚¬: .docxëŠ” zip íŒŒì¼ì˜ PK\x03\x04 ë§¤ì§ë°”ì´íŠ¸ë¡œ ì‹œì‘
    with open(template_path, "rb") as f:
        magic = f.read(4)
    if magic != b'PK\x03\x04':
        raise ValueError(f"File at {template_path} does not look like a valid .docx (magic={magic!r}). "
                         "Maybe it's corrupted or not a real .docx.")

    # 6) ì‹¤ì œ DocxTemplate ë¡œë”©
    try:
        doc = DocxTemplate(str(template_path))
    except Exception as e:
        print("  - DocxTemplate load error:", repr(e))
        raise

    # 7) ë Œë”ë§
    context = contract.content or {}
    doc.render(context)
    return doc'''
async def render_docx(contract):
    """í†µí•©ì‹ ì²­ì„œ í…œí”Œë¦¿(.docx)ì„ ë Œë”ë§í•´ DocxTemplate ê°ì²´ë¡œ ë°˜í™˜."""
    current_dir = os.path.dirname(os.path.abspath(__file__))
    template_path = os.path.join(current_dir, "..", "..", "templates", TEMPLATE_FILE)
    
    # ê²½ë¡œ ë””ë²„ê¹…ìš© (ì„œë²„ ì½˜ì†”ì— ì‹¤ì œ ê²½ë¡œ ì¶œë ¥)
    print(f"ğŸ“‚ Using template path: {template_path}")

    # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
    if not os.path.exists(template_path):
        raise FileNotFoundError(f"âŒ Template not found at {template_path}")

    doc = DocxTemplate(template_path)
    context = contract.content or {}
    doc.render(context)
    return doc
    
    '''# docxtpl ê°ì²´ ìƒì„± ë° í…œí”Œë¦¿ ë¡œë“œ
    try:
        doc = DocxTemplate(template_path)
    except FileNotFoundError:
        # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê±°ë‚˜ ë¹ˆ ë¬¸ì„œë¥¼ ë°˜í™˜í•˜ëŠ” ë“± ì ì ˆíˆ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
        raise FileNotFoundError(f"í…œí”Œë¦¿ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {template_path}. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")

    # 2. DBì˜ JSON ë°ì´í„°ë¥¼ ë Œë”ë§ Contextë¡œ ì‚¬ìš©
    context = contract.content or {} 
    
    # 3. í…œí”Œë¦¿ì— ë°ì´í„° ì±„ìš°ê¸° (ë Œë”ë§)
    doc.render(context)
    
    # ì™„ì„±ëœ docxtpl ê°ì²´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    return doc '''